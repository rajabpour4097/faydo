<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Debug - Faydo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            word-wrap: break-word;
        }
        .success {
            background: #c8e6c9;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #ffcdd2;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            margin: 10px 5px;
            cursor: pointer;
        }
        button:active {
            background: #1976D2;
        }
        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        #logs {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #37474f;
        }
        .log-time {
            color: #80deea;
            font-weight: bold;
        }
        .log-error {
            color: #ff5252;
        }
        .log-success {
            color: #69f0ae;
        }
        .log-info {
            color: #ffd54f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Mobile Debug Tool</h1>
        <p>Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ debug Ú©Ø±Ø¯Ù† Ù…Ø´Ú©Ù„Ø§Øª Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø§Ø³Øª</p>
    </div>

    <div class="container">
        <h2>ğŸ“± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø³ØªÚ¯Ø§Ù‡</h2>
        <div class="info">
            <strong>User Agent:</strong><br>
            <span id="userAgent"></span>
        </div>
        <div class="info">
            <strong>Screen Size:</strong> <span id="screenSize"></span>
        </div>
        <div class="info">
            <strong>Current URL:</strong><br>
            <span id="currentUrl"></span>
        </div>
        <div class="info">
            <strong>API Base URL:</strong><br>
            <span id="apiBaseUrl"></span>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ§ª ØªØ³Øª OTP</h2>
        
        <input type="tel" id="phoneNumber" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† (Ù…Ø«Ø§Ù„: 09111127685)" maxlength="11">
        <button onclick="sendOTP()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯</button>
        
        <input type="text" id="otpCode" placeholder="Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ (6 Ø±Ù‚Ù…)" maxlength="6">
        <button onclick="verifyOTP()">âœ… ØªØ£ÛŒÛŒØ¯ Ú©Ø¯</button>
        
        <button onclick="loginWithOTP()">ğŸ” ÙˆØ±ÙˆØ¯ Ø¨Ø§ OTP</button>
        
        <button onclick="checkLocalStorage()">ğŸ’¾ Ø¨Ø±Ø±Ø³ÛŒ LocalStorage</button>
        <button onclick="clearLocalStorage()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† LocalStorage</button>
        <button onclick="clearLogs()">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Logs</button>
    </div>

    <div class="container">
        <h2>ğŸ“‹ Console Logs</h2>
        <div id="logs"></div>
    </div>

    <script>
        // Initialize
        document.getElementById('userAgent').textContent = navigator.userAgent;
        document.getElementById('screenSize').textContent = window.innerWidth + 'x' + window.innerHeight;
        document.getElementById('currentUrl').textContent = window.location.href;
        
        // API Base URL
        const API_BASE_URL = `${window.location.protocol}//${window.location.host}/api`;
        document.getElementById('apiBaseUrl').textContent = API_BASE_URL;

        // Log function
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const time = new Date().toLocaleTimeString('fa-IR');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            let className = 'log-info';
            let icon = 'â„¹ï¸';
            
            if (type === 'error') {
                className = 'log-error';
                icon = 'âŒ';
            } else if (type === 'success') {
                className = 'log-success';
                icon = 'âœ…';
            }
            
            logEntry.innerHTML = `<span class="log-time">[${time}]</span> <span class="${className}">${icon} ${message}</span>`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            console.log(`[${time}] ${message}`);
        }

        // Send OTP
        async function sendOTP() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber) {
                log('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            if (!phoneNumber.startsWith('09') || phoneNumber.length !== 11) {
                log('Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø¨Ø§ÛŒØ¯ Ø¨Ø§ 09 Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯ Ùˆ 11 Ø±Ù‚Ù… Ø¨Ø§Ø´Ø¯', 'error');
                return;
            }
            
            log(`Ø¯Ø±Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ OTP Ø¨Ù‡ ${phoneNumber}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/accounts/auth/send-otp/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber
                    })
                });
                
                log(`Response Status: ${response.status}`, 'info');
                
                const data = await response.json();
                log(`Response Data: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success) {
                    log(`âœ… Ú©Ø¯ OTP Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ${data.otp_code}`, 'success');
                    if (data.otp_code) {
                        document.getElementById('otpCode').value = data.otp_code;
                    }
                } else {
                    log(`Ø®Ø·Ø§: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${error.message}`, 'error');
                log(`Error Stack: ${error.stack}`, 'error');
            }
        }

        // Verify OTP
        async function verifyOTP() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const otpCode = document.getElementById('otpCode').value;
            
            if (!phoneNumber || !otpCode) {
                log('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ùˆ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            log(`Ø¯Ø±Ø­Ø§Ù„ ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ ${otpCode}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/accounts/auth/verify-otp/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber,
                        otp_code: otpCode
                    })
                });
                
                log(`Response Status: ${response.status}`, 'info');
                
                const data = await response.json();
                log(`Response Data: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success) {
                    log(`âœ… Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ ØµØ­ÛŒØ­ Ø§Ø³Øª`, 'success');
                } else {
                    log(`Ø®Ø·Ø§: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${error.message}`, 'error');
            }
        }

        // Login with OTP
        async function loginWithOTP() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber) {
                log('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', 'error');
                return;
            }
            
            log(`Ø¯Ø±Ø­Ø§Ù„ ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ ${phoneNumber}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/accounts/auth/login-with-otp/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: phoneNumber
                    })
                });
                
                log(`Response Status: ${response.status}`, 'info');
                
                const data = await response.json();
                log(`Response Data: ${JSON.stringify(data, null, 2)}`, 'info');
                
                if (data.success && data.user && data.tokens) {
                    log(`âœ… ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚!`, 'success');
                    
                    // Map user object
                    const mappedUser = {
                        id: data.user.id,
                        username: data.user.username,
                        name: data.user.display_name || `${data.user.first_name} ${data.user.last_name}`.trim() || data.user.username,
                        email: data.user.email,
                        type: data.user.role,
                        phone_number: data.user.phone_number,
                        avatar: data.user.image,
                        display_name: data.user.display_name,
                        first_name: data.user.first_name,
                        last_name: data.user.last_name
                    };
                    
                    log(`Storing user: ${JSON.stringify(mappedUser, null, 2)}`, 'info');
                    
                    // Store in localStorage
                    localStorage.setItem('auth_user', JSON.stringify(mappedUser));
                    localStorage.setItem('access_token', data.tokens.access);
                    localStorage.setItem('refresh_token', data.tokens.refresh);
                    
                    log(`âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± localStorage Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'success');
                    
                    // Verify
                    setTimeout(() => {
                        checkLocalStorage();
                        log(`ğŸš€ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯...`, 'info');
                        setTimeout(() => {
                            window.location.href = '/dashboard';
                        }, 2000);
                    }, 500);
                } else {
                    log(`Ø®Ø·Ø§: ${data.message || 'ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚'}`, 'error');
                }
            } catch (error) {
                log(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${error.message}`, 'error');
            }
        }

        // Check localStorage
        function checkLocalStorage() {
            log('=== Ø¨Ø±Ø±Ø³ÛŒ LocalStorage ===', 'info');
            
            const user = localStorage.getItem('auth_user');
            const accessToken = localStorage.getItem('access_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            if (user) {
                log(`âœ… auth_user: ${user.substring(0, 100)}...`, 'success');
            } else {
                log(`âŒ auth_user: ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯`, 'error');
            }
            
            if (accessToken) {
                log(`âœ… access_token: ${accessToken.substring(0, 50)}...`, 'success');
            } else {
                log(`âŒ access_token: ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯`, 'error');
            }
            
            if (refreshToken) {
                log(`âœ… refresh_token: ${refreshToken.substring(0, 50)}...`, 'success');
            } else {
                log(`âŒ refresh_token: ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯`, 'error');
            }
        }

        // Clear localStorage
        function clearLocalStorage() {
            localStorage.clear();
            log('ğŸ—‘ï¸ LocalStorage Ù¾Ø§Ú© Ø´Ø¯', 'success');
        }

        // Clear logs
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            log('ØµÙØ­Ù‡ Logs Ù¾Ø§Ú© Ø´Ø¯', 'success');
        }

        // Log initial state
        log('ğŸš€ Mobile Debug Tool Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'success');
        checkLocalStorage();
    </script>
</body>
</html>
