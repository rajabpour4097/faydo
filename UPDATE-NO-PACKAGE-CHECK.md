# ุชุบุฑุงุช: ุฌููฺฏุฑ ุงุฒ ุฏุณุชุฑุณ ุจู ฺฉุณุจโูฺฉุงุฑ ุจุฏูู ูพฺฉุฌ ูุนุงู

## ุชุงุฑุฎ: 2025-11-07

## ูุดฺฉู
ุฒูุงู ฺฉู ฺฉุงุฑุจุฑ QR Code ุง ฺฉุฏ ฺฉุชุง ฺฉุณุจโูฺฉุงุฑ ุฑุง ุงุณฺฉู/ูุงุฑุฏ ูโฺฉุฑุฏ ฺฉู ูพฺฉุฌ ูุนุงู ูุฏุงุดุชุ ุจู ุตูุญู ฺฏุฒููโูุง (BusinessOptionsModal) ูุฏุงุช ูโุดุฏ ฺฉู ูุชุฌูโุง ูุฏุงุดุช.

## ุฑุงูโุญู
ุงุถุงูู ฺฉุฑุฏู ุจุฑุฑุณ `has_active_package` ุฏุฑ Frontend ูุจู ุงุฒ ููุงุด BusinessOptionsModal ู ููุงุด ูพุงู ุฎุทุง ููุงุณุจ.

---

## ุชุบุฑุงุช ุงูุฌุงู ุดุฏู

### 1. Frontend: QRScannerModal.tsx

**ูุงู:** `frontend/src/components/scanner/QRScannerModal.tsx`

**ุชุบุฑ ุฏุฑ `fetchBusinessInfo()`:**

```typescript
const fetchBusinessInfo = async (code: string) => {
  setIsLoadingBusiness(true)
  setError(null)
  
  try {
    const info = await loyaltyService.getBusinessByCode(code)
    
    // โ ุจุฑุฑุณ ุฌุฏุฏ: ุขุง ฺฉุณุจโูฺฉุงุฑ ูพฺฉุฌ ูุนุงู ุฏุงุฑุฏุ
    if (!info.has_active_package) {
      setError(`ูุชุฃุณูุงูู "${info.business_name}" ุฏุฑ ุญุงู ุญุงุถุฑ ูพฺฉุฌ ูุนุงู ูุฏุงุฑุฏ ู ุงูฺฉุงู ุงุณุชูุงุฏู ุงุฒ ุชุฎููโูุง ูุฌูุฏ ูุฏุงุฑุฏ`)
      setBusinessInfo(null)
      setShowBusinessOptions(false)
      return  // โ ุฌููฺฏุฑ ุงุฒ ุงุฏุงูู
    }
    
    setBusinessInfo(info)
    setShowBusinessOptions(true)
  } catch (err: any) {
    console.error('Error fetching business info:', err)
    setError(err.error || err.response?.data?.error || 'ฺฉุณุจโูฺฉุงุฑ ุจุง ุงู ฺฉุฏ ุงูุช ูุดุฏ')
  } finally {
    setIsLoadingBusiness(false)
  }
}
```

**ุจูุจูุฏ ููุงุด ุฎุทุง:**

```tsx
{error ? (
  <div className="text-center py-12">
    {/* ุขฺฉูู ุฎุทุง ุจูุชุฑ */}
    <div className="w-20 h-20 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center">
      <svg className="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    
    {/* ุนููุงู ุฎุทุง */}
    <p className={`text-lg font-bold mb-2 ${isDark ? 'text-white' : 'text-gray-900'}`}>
      ุฎุทุง
    </p>
    
    {/* ูุชู ุฎุทุง */}
    <p className="text-red-500 mb-6 px-4">{error}</p>
    
    {/* ุฏฺฉูู ุชูุงุด ูุฌุฏุฏ ุจูุจูุฏ ุงูุชู */}
    <button
      onClick={() => {
        setError(null)
        setShowManualEntry(false)
        setManualCode('')
        startScanner()
      }}
      className="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-colors"
    >
      ุชูุงุด ูุฌุฏุฏ
    </button>
  </div>
) : (
  // ... ุจูู UI
)}
```

---

## ูุญูู ฺฉุงุฑ

### ูุจู ุงุฒ ุชุบุฑ:
```
ฺฉุงุฑุจุฑ ฺฉุฏ ุฑุง ูุงุฑุฏ ูโฺฉูุฏ
    โ
API ูุฑุงุฎูุงู ูโุดูุฏ
    โ
BusinessInfo ุฏุฑุงูุช ูโุดูุฏ (has_active_package: false)
    โ
โ BusinessOptionsModal ุจุงุฒ ูโุดูุฏ (ุจุง ฺฏุฒููโูุง ุบุฑูุนุงู)
```

### ุจุนุฏ ุงุฒ ุชุบุฑ:
```
ฺฉุงุฑุจุฑ ฺฉุฏ ุฑุง ูุงุฑุฏ ูโฺฉูุฏ
    โ
API ูุฑุงุฎูุงู ูโุดูุฏ
    โ
BusinessInfo ุฏุฑุงูุช ูโุดูุฏ (has_active_package: false)
    โ
โ ุจุฑุฑุณ ูโุดูุฏ: has_active_package === false?
    โ
โ ูพุงู ุฎุทุง ููุงุด ุฏุงุฏู ูโุดูุฏ
    โ
โ ุฏุฑ QRScannerModal ุจุงู ูโูุงูุฏ
```

---

## API Response

Backend ููฺูุงู ููุงู response ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ:

```json
{
  "business_id": 1,
  "business_name": "ูุงู ฺฉุณุจโูฺฉุงุฑ",
  "has_active_package": false,  // โ ุงู ููุฏ ฺฺฉ ูโุดูุฏ
  "discount_all_percentage": null,
  "has_specific_discount": false,
  ...
}
```

---

## ุณูุงุฑููุง ูุฎุชูู

### โ ุณูุงุฑู 1: ฺฉุณุจโูฺฉุงุฑ ุจุฏูู ูฺ Package
- **ูุถุนุช:** `business.packages.count() = 0`
- **ูุชุฌู:** `has_active_package = false`
- **UI:** ูพุงู ุฎุทุง ููุงุด ุฏุงุฏู ูโุดูุฏ

### โ ุณูุงุฑู 2: Package ุฏุงุฑุฏ ุงูุง ุบุฑูุนุงู
- **ูุถุนุช:** `package.is_active = False`
- **ูุชุฌู:** `has_active_package = false`
- **UI:** ูพุงู ุฎุทุง ููุงุด ุฏุงุฏู ูโุดูุฏ

### โ ุณูุงุฑู 3: Package ุฏุงุฑุฏ ุงูุง ุชุงุฏ ูุดุฏู
- **ูุถุนุช:** `package.status != 'approved'`
- **ูุชุฌู:** `has_active_package = false`
- **UI:** ูพุงู ุฎุทุง ููุงุด ุฏุงุฏู ูโุดูุฏ

### โ ุณูุงุฑู 4: Package ูุนุงู ู ุชุงุฏ ุดุฏู ุฏุงุฑุฏ
- **ูุถุนุช:** `package.is_active = True AND status = 'approved'`
- **ูุชุฌู:** `has_active_package = true`
- **UI:** ุจู BusinessOptionsModal ูโุฑูุฏ โจ

---

## ูพุงูโูุง ุฎุทุง

### ุฎุทุง "ุจุฏูู ูพฺฉุฌ ูุนุงู":
```
ูุชุฃุณูุงูู "[ูุงู ฺฉุณุจโูฺฉุงุฑ]" ุฏุฑ ุญุงู ุญุงุถุฑ ูพฺฉุฌ ูุนุงู ูุฏุงุฑุฏ ู ุงูฺฉุงู ุงุณุชูุงุฏู ุงุฒ ุชุฎููโูุง ูุฌูุฏ ูุฏุงุฑุฏ
```

### ุฎุทุง "ฺฉุฏ ุงูุช ูุดุฏ":
```
ฺฉุณุจโูฺฉุงุฑ ุจุง ุงู ฺฉุฏ ุงูุช ูุดุฏ
```

### ุฎุทุง "ฺฉุฏ ูุงูุนุชุจุฑ":
```
ฺฉุฏ ฺฉุชุง ุจุงุฏ ุนุฏุฏ ุจุงุดุฏ
```

---

## ุชุณุช

ุจุฑุง ุชุณุช ุงู ูฺฺฏ:

1. ฺฉ ฺฉุณุจโูฺฉุงุฑ ุจุฏูู ูพฺฉุฌ ุง ุจุง ูพฺฉุฌ ุบุฑูุนุงู ุงุฌุงุฏ ฺฉูุฏ
2. ุจุง ุญุณุงุจ ูุดุชุฑ ูุงุฑุฏ ุดูุฏ
3. QR Scanner ุฑุง ุจุงุฒ ฺฉูุฏ
4. ฺฉุฏ ฺฉุชุง ุขู ฺฉุณุจโูฺฉุงุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ
5. **ุงูุชุธุงุฑ:** ูพุงู ุฎุทุง ููุงุด ุฏุงุฏู ุดูุฏ ู ุจู BusinessOptions ูุฑูุฏ

ูุณุชูุฏุงุช ฺฉุงูู ุชุณุช: `TEST-NO-ACTIVE-PACKAGE.md`

---

## ูุงูโูุง ุชุบุฑ ุงูุชู

```
frontend/src/components/scanner/QRScannerModal.tsx  โ ุชุบุฑ ุฏุฑ fetchBusinessInfo ู UI ุฎุทุง
```

## ูุงูโูุง ูุณุชูุฏุงุช ุฌุฏุฏ

```
TEST-NO-ACTIVE-PACKAGE.md        โ ุฑุงูููุง ุชุณุช
UPDATE-NO-PACKAGE-CHECK.md       โ ุงู ูุงู
```

---

## ูุฒุงุง

โ **ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ:** ฺฉุงุฑุจุฑ ุจูุงูุงุตูู ูุชูุฌู ูุดฺฉู ูโุดูุฏ

โ **ุฌููฺฏุฑ ุงุฒ ุณุฑุฏุฑฺฏู:** ุจู ุตูุญูโุง ุจุง ฺฏุฒููโูุง ุบุฑูุนุงู ููโุฑูุฏ

โ **ูพุงู ุฑูุดู:** ูุงู ฺฉุณุจโูฺฉุงุฑ ู ุฏูู ุฎุทุง ูุดุฎุต ุงุณุช

โ **ุงูฺฉุงู ุชูุงุด ูุฌุฏุฏ:** ฺฉุงุฑุจุฑ ูโุชูุงูุฏ ฺฉุฏ ุฏฺฏุฑ ุงูุชุญุงู ฺฉูุฏ

โ **ุซุจุงุช:** state ูุง ุจู ุฏุฑุณุช reset ูโุดููุฏ

---

## ูฺฉุงุช ูู

1. **ุจุฑุฑุณ ุณูุช Client:** ฺฺฉ ุฏุฑ Frontend ุงูุฌุงู ูโุดูุฏ (ุจูุชุฑ ุงุฒ ุงูุชุธุงุฑ ุจุฑุง Backend error)

2. **State Management:** 
   - `setBusinessInfo(null)` โ ุงุทูุงุนุงุช ฺฉุณุจโูฺฉุงุฑ ูพุงฺฉ ูโุดูุฏ
   - `setShowBusinessOptions(false)` โ Modal ุจุงุฒ ููโุดูุฏ
   - `setError(...)` โ ูพุงู ุฎุทุง ููุงุด ุฏุงุฏู ูโุดูุฏ

3. **Early Return:** ุจุง `return` ุงุฒ ุงุฏุงูู ฺฉุฏ ุฌููฺฏุฑ ูโุดูุฏ

4. **ุฏฺฉูู ุชูุงุด ูุฌุฏุฏ:** ููู state ูุง ุฑุง ูพุงฺฉ ูโฺฉูุฏ ู ุงุณฺฉูุฑ ุฑุง ุฏูุจุงุฑู ูุนุงู ูโฺฉูุฏ

---

## ุณุงุฒฺฏุงุฑ ุจุง Backend

ุงู ุชุบุฑ ููุท ุฏุฑ Frontend ุงุณุช ู ูุงุฒ ุจู ุชุบุฑ Backend ูุฏุงุฑุฏ ฺูู:
- API ุงุฒ ูุจู `has_active_package` ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ
- ููุทู ููุชุฑ Package ุฏุฑ Backend ุตุญุญ ุงุณุช
- ููุท ูุญูู ุงุณุชูุงุฏู ุงุฒ ุงู ุฏุงุฏู ุฏุฑ Frontend ุชุบุฑ ฺฉุฑุฏู

---

โ **ูุถุนุช:** ุชฺฉูู ุดุฏู ู ุขูุงุฏู ุชุณุช
๐ฏ **ูุฏู:** ุฌููฺฏุฑ ุงุฒ ุฏุณุชุฑุณ ุจู ฺฉุณุจโูฺฉุงุฑูุง ุจุฏูู ูพฺฉุฌ ูุนุงู
๐ **ููุน ุชุบุฑ:** ุจูุจูุฏ UX ู Validation
